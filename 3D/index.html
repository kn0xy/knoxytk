<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Knoxy3D</title>
        <link rel="stylesheet" type="text/css" href="knoxy.css">
		<style type="text/css">
            #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 85;
            background-color: #000;
            color: #CCC;
            font-family: monospace;
            overflow: hidden;
        }
        </style>
	</head>
	<body>
        <div id="loadingOverlay"> <!--  style="display:none" -->
            <pre>
KKKKKKKKK    KKKKKKK                                                                              
K:::::::K    K:::::K                                                                              
K:::::::K    K:::::K                                                                              
K:::::::K   K::::::K                                                                              
KK::::::K  K:::::KKKnnnn  nnnnnnnn       ooooooooooo xxxxxxx      xxxxxxxyyyyyyy           yyyyyyy
  K:::::K K:::::K   n:::nn::::::::nn   oo:::::::::::oox:::::x    x:::::x  y:::::y         y:::::y 
  K::::::K:::::K    n::::::::::::::nn o:::::::::::::::ox:::::x  x:::::x    y:::::y       y:::::y  
  K:::::::::::K     nn:::::::::::::::no:::::ooooo:::::o x:::::xx:::::x      y:::::y     y:::::y   
  K:::::::::::K       n:::::nnnn:::::no::::o     o::::o  x::::::::::x        y:::::y   y:::::y    
  K::::::K:::::K      n::::n    n::::no::::o     o::::o   x::::::::x          y:::::y y:::::y     
  K:::::K K:::::K     n::::n    n::::no::::o     o::::o   x::::::::x           y:::::y:::::y      
KK::::::K  K:::::KKK  n::::n    n::::no::::o     o::::o  x::::::::::x           y:::::::::y       
K:::::::K   K::::::K  n::::n    n::::no:::::ooooo:::::o x:::::xx:::::x           y:::::::y        
K:::::::K    K:::::K  n::::n    n::::no:::::::::::::::ox:::::x  x:::::x           y:::::y         
K:::::::K    K:::::K  n::::n    n::::n oo:::::::::::oox:::::x    x:::::x         y:::::y          
KKKKKKKKK    KKKKKKK  nnnnnn    nnnnnn   ooooooooooo xxxxxxx      xxxxxxx       y:::::y           
                                                                               y:::::y            
                                                                              y:::::y             
                                                                             y:::::y              
                                                                            y:::::y               
                                                                           yyyyyyy
            </pre>
            <h1 style="margin-bottom:50px">Portfolio/Showcase: May 2023</h1>
            <h1 id="init">Initializing...</h1>
        </div>
        <div id="wrapper">
            <canvas id="knoxy"></canvas>
            <div id="labels"></div>
            <div id="overlay">
                <div id="overlayClose">&times;</div>
                <div id="overlayContent"></div>
            </div>
            <div id="contextMenu">
                <ul id="contextContent"></ul>
            </div>
            <div id="ui">
                <div id="ui-inner"></div>
            </div>
        </div>
        <iframe id="frame1"></iframe>
        <iframe id="frame2"></iframe>
        <script>
            window.name = 'KnoxyHQ';
            window.loadedM0 = false;
            window.loadedM1 = false;
            window.loadedM2 = false;
            window.loadedModels = false;
            function loadingSlow() {
                let lwTxt = 'Loading world';
                for(var i=0; i<30; i++) lwTxt += '.';
                lwTxt += loadingPercent+'%';
                document.getElementById('initLoader2').innerHTML = lwTxt;
            }
            function initScene(loaded) {
                if(!document.getElementById('init')) {
                    let newInit = document.createElement('h1');
                    newInit.id = 'init';
                    newInit.innerHTML = 'Loading scene...' + (loaded ? 'OK!' : '');
                    document.getElementById('loadingOverlay').appendChild(newInit);
                } else {
                    document.getElementById('init').append('OK!');
                }
            }
            let engine = null;
            let loadingTime = 0;
            let loadingPercent = 0;
            let showPercent = false;
            let loading = setInterval(function() {
                if(loadedM0 && loadedM1 && loadedM2) {
                    const il2 = document.getElementById('initLoader2');
                    if(!loadedModels) {
                        // engine + monitors loaded, still waiting on models
                        if(loadingTime < 30) {
                            il2.append('.');
                        } else {
                            loadingSlow();
                        }
                        loadingTime++;
                    } else {
                        // everything is loaded
                        clearInterval(loading);
                        const overlay = document.getElementById('loadingOverlay');
                        
                        // update loading texts
                        let lpt = il2.textContent;
                        let len = lpt.length - 3;
                        let lps = lpt.substring(0, len);
                        il2.innerHTML = lps + 'OK!';
                        initScene(true);
                        
                        // show welcome message
                        let loaded = document.createElement('h1');
                        loaded.innerHTML = 'Welcome to knoxy.tk!<br><br>';
                        overlay.appendChild(loaded);
                        overlay.scrollTop = overlay.scrollHeight;
                        engine.callAnimate();
                        setTimeout(loadingComplete, 1000);
                        function loadingComplete() {
                            try {
                                // append loadingOverlay html to #loadingSection in monitor2.html
                                engine.scene.monitor2.screenContent.getElementById('loadingSection').innerHTML = overlay.innerHTML;

                                // remove loading overlay
                                overlay.parentNode.removeChild(overlay);

                                // move camera to tippyDesk
                                setTimeout(function() {
                                    engine.ui.moveCameraTo('tippyDesk', null, null, () => {
                                        // initialize UI panel overlay
                                        engine.ui.panel.init();
                                        // slide out the desk tray
                                        engine.tippyDesk.toggleTray();
                                    });
                                }, 500);
                            } catch(e) {
                                console.error(e);
                                setTimeout(loadingComplete, 250);
                            }
                        }
                    }  
                } else {
                    if(loadedModels) {
                        const oldInit = document.getElementById('init');
                        if(!oldInit) {
                            initScene();
                        } else {
                            // waiting for monitor contents to initialize (loading scene)
                            oldInit.append('.');
                        }
                    } else {
                        try {
                            // waiting for models to download
                            if(loadingTime > 30) {
                                loadingSlow();
                            } else {
                                document.getElementById('initLoader2').append('.');
                            }
                            loadingTime++;
                        } catch {
                            // still initializing (body hasn't reached onload)
                            document.getElementById('init').append('.');
                        }
                    }
                }   
            }, 250);
            function initLoader() {
                try {
                    const loader = engine.loader;
                    loader.manager.onProgress = function(url, loaded, total) {
                        const overlay = document.getElementById('loadingOverlay');
                        let loading = 'Loading';
                        let progElem = document.createElement('h1');
                        url = url.replace(window.location.origin+'/', '');
                        if(url.substring(0,4) === 'blob') {
                            loading = 'Started thread';
                            url = url.replace('blob:', '');
                        } else if(loader.filesLoaded.includes(url)) {
                            url = url.replace('models/', 'knoxy/');
                            url = url.replace('.glb', '');
                            loading = 'Loaded';
                        }
                        progElem.innerHTML = loading+' '+url;
                        overlay.appendChild(progElem);
                        overlay.scrollTop = overlay.scrollHeight;
                        loader.filesLoaded.push(url);
                        loadingPercent = parseInt(loaded / total * 100);
                    }
                } catch(err) {
                    console.error('failed to set loader progress', err);
                }
            }
            document.body.onload = function() {
                document.getElementById('init').append('OK!');
                document.getElementById('init').id = 'initLoader1';
                let newInit = document.createElement('h1');
                newInit.id = 'initLoader2';
                newInit.innerHTML = 'Loading world...';
                document.getElementById('loadingOverlay').appendChild(newInit);
                loadedM0 = true;
                initLoader();
            }
        </script>
		<script async type="module" src="js/knoxyEngine.js"></script>
	</body>
</html>